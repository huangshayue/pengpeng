# 在线对战功能设置指南

## 步骤1：开通云开发

1. 在微信开发者工具中打开项目
2. 点击顶部菜单的"云开发"按钮
3. 如果还没开通，点击"开通云开发"
4. 选择免费套餐即可（每月有免费额度）
5. 记下你的环境ID（类似：cloud1-xxxxx）

## 步骤2：初始化云环境

1. 在微信开发者工具中，确保你的环境ID在 `project.config.json` 中正确配置：
   ```json
   "cloudbaseEnv": "你的环境ID"
   ```

## 步骤3：部署云函数

1. 在微信开发者工具中，右键点击 `cloudfunctions/gameRoom` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成（第一次可能需要1-2分钟）
4. 看到"上传成功"提示即可

## 步骤4：创建数据库集合

1. 在微信开发者工具中，点击"云开发"按钮
2. 进入云开发控制台
3. 选择"数据库"标签
4. 点击"+"创建集合
5. 集合名称输入：`pengpeng_rooms`
6. 权限设置选择"所有用户可读，仅创建者可写"
7. 点击"确定"创建

## 步骤5：初始化云开发（在小游戏代码中）

确保在 `game.js` 文件开头添加云开发初始化代码：

```javascript
// 初始化云开发
if (wx.cloud) {
  wx.cloud.init({
    env: 'your-env-id', // 替换为你的环境ID
    traceUser: true
  })
}
```

## 步骤6：测试在线功能

1. 编译并运行小游戏
2. 选择"在线对战"模式
3. 创建房间，会生成6位房间号
4. 点击"邀请好友"分享给朋友
5. 朋友点击链接会自动加入房间
6. 双方都选择动作后，会同时执行

## 常见问题

### Q: 提示"云函数调用失败"
A: 检查云函数是否已部署，环境ID是否正确

### Q: 提示"数据库操作失败"
A: 检查数据库集合是否已创建，权限是否正确设置

### Q: 无法创建房间
A: 检查云开发是否已初始化，网络是否正常

### Q: 对手加入后没有反应
A: 确保轮询间隔正常（默认1秒），检查云函数日志

## 调试技巧

1. **查看云函数日志**：
   - 云开发控制台 → 云函数 → gameRoom → 日志
   - 可以看到所有函数调用记录和错误信息

2. **查看数据库内容**：
   - 云开发控制台 → 数据库 → pengpeng_rooms
   - 可以实时查看房间状态和消息

3. **本地调试**：
   - 如果云函数不可用，系统会自动降级到本地模式
   - 本地模式仅支持同设备的PVP对战

## 优化建议

1. **减少轮询频率**：如果觉得请求太频繁，可以在 `onlineManager.js` 中调整轮询间隔：
   ```javascript
   // 将1000改为2000，即2秒轮询一次
   this.pollInterval = setInterval(() => {
     this.pollMessages();
   }, 2000);
   ```

2. **添加断线重连**：在 `onlineManager.js` 中添加重连逻辑

3. **优化消息同步**：可以使用WebSocket替代轮询，但需要额外配置

## 云开发免费额度

微信云开发基础版（免费）额度：
- 云函数：每月20万次调用
- 数据库：每月5万次读，3万次写
- 存储：5GB

对于小规模游戏完全够用。