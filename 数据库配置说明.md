# 数据库配置说明

## 手动创建数据库集合

### 方法一：通过微信开发者工具云开发控制台（推荐）

1. 打开微信开发者工具
2. 点击顶部菜单栏的"云开发"按钮
3. 进入云开发控制台
4. 选择左侧菜单的"数据库"
5. 点击"新建集合"按钮
6. 输入集合名称：`pengpeng_rooms`
7. 点击"确定"创建集合

### 方法二：通过云函数自动初始化

1. 在微信开发者工具中，右键点击 `cloudfunctions/initDatabase` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
4. 游戏启动时会自动调用该云函数初始化数据库

### 集合权限配置

创建集合后，需要设置权限：

1. 在云开发控制台的数据库页面
2. 找到 `pengpeng_rooms` 集合
3. 点击集合名称进入详情
4. 点击"权限设置"标签
5. 选择权限模式：
   - 推荐选择"自定义安全规则"
   - 或者临时选择"所有用户可读，仅管理员可写"（用于测试）

### 自定义安全规则示例

```json
{
  "read": true,
  "write": "auth.openid != null"
}
```

这个规则允许所有人读取，但只有登录用户可以写入。

## 云函数部署顺序

请按以下顺序部署云函数：

1. `initDatabase` - 初始化数据库
2. `gameRoom` - 房间管理核心功能
3. `debugRoom` - 调试工具（可选）
4. `cleanRooms` - 清理超时房间（可选）

每个云函数的部署方法：
1. 右键点击云函数文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

## 测试步骤

1. 确保数据库集合已创建
2. 确保所有云函数已部署
3. 重新编译运行小游戏
4. 测试在线对战功能：
   - 创建房间
   - 加入房间
   - 对战游戏

## 常见问题

### 问题1：提示"database collection not exists"
- 原因：数据库集合未创建
- 解决：按照上述方法创建 `pengpeng_rooms` 集合

### 问题2：提示"云函数不存在"
- 原因：云函数未部署
- 解决：部署对应的云函数

### 问题3：提示"权限不足"
- 原因：数据库集合权限设置不正确
- 解决：检查并修改集合的权限设置